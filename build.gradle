plugins {
    id 'java'
    id "com.github.spacialcircumstances.gradle-cucumber-reporting" version "0.1.25"
    id "org.sonarqube" version "5.0.0.4638"
    id 'maven-publish'
}

apply plugin: 'jacoco'

group = 'com.example'
version = '1.0'

repositories {
    mavenCentral()
}

dependencies {
    testImplementation 'io.cucumber:cucumber-java:6.0.0'
    testImplementation 'io.cucumber:cucumber-junit:6.0.0'
    testImplementation 'junit:junit:4.13.1'
}

configurations {
    mailRuntime
}

dependencies {
    mailRuntime 'com.sun.mail:jakarta.mail:2.0.1'
}

jacoco {
    toolVersion = "0.8.11"
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required.set(true)
        csv.required.set(false)
        html.outputLocation.set(layout.buildDirectory.dir('reports/jacoco'))
    }
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            groupId = 'com.example'
            artifactId = 'TP05'
            version = '1.0'
        }
    }

    repositories {
        // Repository local (garde celui-ci)
        maven {
            name = 'local'
            url = uri("${buildDir}/repo")
        }

        // Repository mymavenrepo.com (ajoutez celui-ci)
        maven {
            name = 'myMavenRepo'
            url = uri("https://mymavenrepo.com/repo/YOUR_REPO_ID/")
            credentials {
                username = System.getenv("MAVEN_USERNAME") ?: 'votre-username'
                password = System.getenv("MAVEN_PASSWORD") ?: 'votre-password'
            }
        }
    }
}

sonarqube {
    properties {
        property "sonar.projectKey", "matrix-api"
        property "sonar.projectName", "Matrix API"
        property "sonar.host.url", "http://localhost:9000"
        property "sonar.login", "admin"
        property "sonar.password", "admin"
    }
}

//import groovy.json.JsonOutput
//import java.net.HttpURLConnection
//import java.net.SocketTimeoutException

//tasks.register('slackNotify') {
//    doLast {
//        def webhookUrl = "https://hooks.slack.com/services/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"
//        def message = "‚úÖ D√©ploiement r√©ussi du projet TP05 version 1.0 !"
//
//        println "üì§ Envoi de la notification Slack..."
//
//        try {
//            def url = new URL(webhookUrl)
//            def connection = (HttpURLConnection) url.openConnection()
//            connection.setRequestMethod("POST")
//            connection.setDoOutput(true)
//            connection.setRequestProperty("Content-Type", "application/json")
//            connection.setConnectTimeout(5000)
//            connection.setReadTimeout(5000)
//
//            def payload = JsonOutput.toJson([text: message])
//
//            connection.outputStream.withWriter("UTF-8") { writer ->
//                writer.write(payload)
//            }
//
//            def responseCode = connection.responseCode
//
//            if (responseCode == 200) {
//                println "‚úÖ Notification Slack envoy√©e avec succ√®s !"
//            } else {
//                println "‚ö†Ô∏è Code de r√©ponse inhabituel: ${responseCode}"
//            }
//
//            connection.disconnect()
//
//        } catch (SocketTimeoutException e) {
//            println "‚ö†Ô∏è Timeout lors de l'envoi de la notification Slack (connexion lente)"
//        } catch (Exception e) {
//            println "‚ö†Ô∏è Impossible d'envoyer la notification Slack: ${e.message}"
//        }
//    }
//}
//
//tasks.register('mailNotify') {
//    doLast {
//        println "üìß Envoi de la notification par email..."
//
//        try {
//            // Configuration
//            String host = "smtp.gmail.com"
//            String from = "lo_benhebbadj@esi.dz"
//            String to = "h_mokeddem@esi.dz"
//            String password = "edjq ewnp lbzw sroz"
//
//            // Cr√©ation du classloader avec les d√©pendances mail
//            def mailClasspath = configurations.mailRuntime.files
//            def urls = mailClasspath.collect { it.toURI().toURL() } as URL[]
//            def loader = new URLClassLoader(urls, this.class.classLoader)
//
//            // Chargement des classes
//            def Session = loader.loadClass('jakarta.mail.Session')
//            def Authenticator = loader.loadClass('jakarta.mail.Authenticator')
//            def PasswordAuthentication = loader.loadClass('jakarta.mail.PasswordAuthentication')
//            def MimeMessage = loader.loadClass('jakarta.mail.internet.MimeMessage')
//            def InternetAddress = loader.loadClass('jakarta.mail.internet.InternetAddress')
//            def Transport = loader.loadClass('jakarta.mail.Transport')
//            def MessageRecipientType = loader.loadClass('jakarta.mail.Message$RecipientType')
//
//            // Configuration des propri√©t√©s SMTP
//            Properties props = new Properties()
//            props.put("mail.smtp.auth", "true")
//            props.put("mail.smtp.starttls.enable", "true")
//            props.put("mail.smtp.host", host)
//            props.put("mail.smtp.port", "587")
//
//            // Cr√©ation de l'authenticator avec une classe anonyme
//            def passwordAuth = PasswordAuthentication.getConstructor(String, String).newInstance(from, password)
//            def auth = [
//                    getPasswordAuthentication: { -> passwordAuth }
//            ].asType(Authenticator)
//
//            // Cr√©ation de la session
//            def session = Session.getInstance(props, auth)
//
//            // Cr√©ation du message
//            def message = MimeMessage.getConstructor(Session).newInstance(session)
//            message.setFrom(InternetAddress.getConstructor(String).newInstance(from))
//            message.setRecipients(MessageRecipientType.TO, InternetAddress.parse(to))
//            message.setSubject("D√©ploiement r√©ussi du projet TP05")
//            message.setText("La librairie TP05 version 1.0 a √©t√© d√©ploy√©e avec succ√®s sur le repository Maven local.")
//
//            // Envoi
//            Transport.send(message)
//
//            println "‚úÖ Email envoy√© avec succ√®s !"
//
//        } catch (Exception e) {
//            println "‚ö†Ô∏è Impossible d'envoyer l'email: ${e.message}"
//            e.printStackTrace()
//            println "\nüìù Pour configurer Gmail :"
//            println "   1. Activer l'authentification √† 2 facteurs"
//            println "   2. G√©n√©rer un mot de passe d'application sur https://myaccount.google.com/apppasswords"
//            println "   3. Remplacer 'votreEmail@gmail.com' et 'MOT_DE_PASSE_APPLICATION' dans build.gradle"
//        }
//    }
//}
//
//publish.finalizedBy(slackNotify)
//publish.finalizedBy(mailNotify)

test {
    useJUnit()
    systemProperty "cucumber.publish.enabled", "false"
    systemProperty "cucumber.plugin", "html:build/reports/cucumber/index.html"
}

cucumberReports {
    outputDir = file('build/reports/cucumber/html')
    buildId = '0'
    reports = files('reports/example-report.json')
}